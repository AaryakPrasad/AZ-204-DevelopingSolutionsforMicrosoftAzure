# Lab 09: Publish and subscribe to Event Grid events

## Architecture diagram

![Architecture diagram depicting a user publishing and subscribing to Event Grid events.](./media/Lab09-Diagram.png)

## Lab setup and pre-requisites

Before starting this lab, you must complete **Prerequisites** of this lab.

To install **C#** extension for this lab, follow the below steps in visual studio code:

1. Start Visual Studio Code which can be found in the start menu/desktop.

     ![Visual Studio Code Icon](./media/vscode.jpg)

2. Select the **Extensions** blade from the left panel.
3. Search with **C#** and select **Install** to install the extension.

    ![](./media/vsds.png)

4. After installing C# extensions, close the Visual studio code.

# Exercise 1: Create Azure resources

## Task 1: Open the Azure portal

1. If you are not logged in already, click on Azure portal shortcut that is available on the desktop and log in with Azure credentials.

1. To get the Azure credentials select the **Environment Details** tab from the lab environment details page.

    ![](./media/image-100.png)
    
1. On the Welcome to Microsoft Edge page, select **Start without your data** and on the help for importing Google browsing data page, select the **Continue without this data** button. Then, proceed to select **Confirm and start browsing** on the next page.

## Task 2: Open Azure Cloud Shell

1. From the Azure portal, open the **Azure Cloud Shell** ![Cloud Shell icon](./media/az204_lab_CloudShell.png) to open a new Bash session.

1. When prompted to select either **Bash** or **PowerShell**, select **PowerShell**.

    > **Note**: When prompted, select **Show advanced settings** and then select **Use existing** and choose existing resource group. Then select **Create new** against Storage account as well as File Share and provide a unique value in both of the fields and then click on **Create storage**, and wait for the Azure Cloud Shell to initialize. 

## Task 3: Review the Microsoft.EventGrid provider registration

1. At the **Cloud Shell** command prompt in the portal, perform the following actions:

    a. Run the following command to get a list of subgroups and commands at the root level of the Azure CLI:

    ```bash
    az --version
    ```
    
    b. Run the following command to get a list of subgroups and commands at the root level of the Azure CLI:

    ```bash
    az --help
    ```

    c. Run the following command to get a list of the commands that are available for resource providers:

    ```bash
    az provider --help
    ```

    d. Run the following command to list all currently registered providers:

   ```bash
   az provider list
   ```

    e. Run the following command to list just the namespaces of the currently registered providers:

   ```bash
   az provider list --query "[].namespace"
   ```

    f. Review the list of currently registered providers. Notice that the **Microsoft.EventGrid** provider is currently included in the list of providers.

1. Close the **Cloud Shell** pane.

## Task 4: Create a custom Event Grid topic

1. On the Azure portal's navigation pane, select **Create a resource**.

1. On the **Create a resource** blade, in the **Search services and marketplace** text box, enter **Event Grid Topic**, and then select Enter.

1. On the **Marketplace** search results blade, select the **Event Grid Topic** result, and then select **Create**.

1. On the **Create Topic** blade, on the **Basics** tab, perform the following actions:

    | Setting                           | Action                                                                 |
    | --------------------------------- | ------------------------------------------------------------           |
    | **Subscription** drop-down list   | Retain the default value.                                              |
    | **Resource group** drop-down list | Select **Existing**, enter **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** .|
    | **Name** text box                 | Enter **hrtopic<inject key="DeploymentID" enableCopy="false"/>**                                         |
    | **Region** drop-down list         | Choose the region where the **Resource group** has been deployed..                                                    |

1. On the **Basics** tab, click on **Networking**.

1. On the **Networking** tab, leave the values as default and click on **Advanced**.

1. On the **Advanced** tab, from the **Event Schema** drop-down list, select **Event Grid Schema**, and then select **Review + create**.

1. On the **Review + create** tab, review the options that you selected during the previous steps.

1. Select **Create** to create the event grid topic by using your specified configuration.
  
    > **Note**: Wait for Azure to finish creating the topic before you continue with the lab. You'll receive a notification when the topic is created.

## Task 5: Deploy the Azure Event Grid viewer to a web app

1. Copy the link and paste it into a new tab of the browser in **[Deploy to Azure](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FAzure-Samples%2Fazure-event-grid-viewer%2Fmaster%2Fazuredeploy.json)** link. This will automatically redirect you to the **Custom deployment** blade in the Azure portal.

1. On the Custom deployment page, do the following steps:

   | Setting                           | Action                                                                                        |
   | --------------------------------- | ---------------------------------------------------------------------------------             |
   | **Subscription** drop-down list   | Retain the default value.                                                                     |
   | **Resource group** drop-down list | Select **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** in the list.                                             |
   | **Region** drop-down list         | Retain the default value.                                                                           |
   | **Site Name** text box            | Enter **eventviewer<inject key="DeploymentID" enableCopy="false"/>**                                                          |
   | **Hosting plan name** section     | Enter **eventviewerplan<inject key="DeploymentID" enableCopy="false"/>**                                                      |
   | **SKU and size** section          | Retain the default value.                                                                     |
   
   The following screenshot displays the configured settings on the **Create Web App** blade.
   
      ![Screenshot displaying the configured settings on the Create Web App blade](./media/AZ-204-09.png)

1. Select Review + create

1. On the Review + create page, select Create.
  
    > **Note**: Wait for Azure to finish creating the web app before you continue with the lab. You'll receive a notification when the app is created.

 > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:

 - Navigate to the Lab Validation Page, from the upper right corner in the lab guide section.
 - Hit the Validate button for the corresponding task. If you receive a success message, you can proceed to the next task. 
 - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
 - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.
### Review

In this exercise, you created the Event Grid topic and a web app that you will use throughout the remainder of the lab.

# Exercise 2: Create an Event Grid subscription

## Task 1: Access the Event Grid Viewer web application

1. On the Azure portal's navigation pane, select **Resource groups**.

1. On the **Resource groups** blade, select the **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** resource group.

1. On the **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** blade, select the **eventviewer<inject key="DeploymentID" enableCopy="false"/>** web app.

1. On the **App Service** blade, in the **Settings** category, select the **Properties** link..

1. In the **Properties** section, record the value of the **URL** link. You'll use this value later in the lab.

1. Select **Overview**, and then select **Browse**.

1. Observe the currently running **Azure Event Grid Viewer** web application. Leave this web application running for the remainder of the lab.

    > **Note**: This web application will update in real time as events are sent to its endpoint. You'll use this application to monitor events throughout the lab.

1. Return to your currently open browser window that displays the Azure portal.

## Task 2: Create a new subscription

1. On the Azure portal's navigation pane, select **Resource groups**.

1. On the **Resource groups** blade, select the **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** resource group that you created previously in this lab.

1. On the **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** blade, select the **hrtopic<inject key="DeploymentID" enableCopy="false"/>** Event Grid topic that you created previously in this lab.

1. On the **Event Grid Topic** blade, select **+ Event Subscription**.

1. On the **Create Event Subscription** blade, perform the following actions, and then select **Confirm Selection**:

    | Setting                          | Action                                                       |
    | -------------------------------- | ------------------------------------------------------------ |
    | **Name** text box                | Enter **basicsub**                                          |
    | **Event Schema** drop-down list  | Select **Event Grid Schema**.                                |
    | **Endpoint Type** drop-down list | Select **Web Hook**.                                         |
    | **Endpoint**                     | Select **Select an endpoint**. In the **Subscriber Endpoint** text box, enter the **Web App URL** value that you recorded previously, ensure that it uses an **https://** prefix, add the suffix **/api/updates**, and then select **Confirm Selection**. For example, if your **Web App URL** value is ``http://eventviewerstudent.azurewebsites.net/``, then your **Subscriber Endpoint** would be ``https://eventviewerstudent.azurewebsites.net/api/updates``. |
    
1. Click on the **Create** button.

   The following screenshot displays the configured settings on the **Create Event Subscription** blade.

   ![Screenshot displaying the configured settings on the Create Event Subscription blade](./media/l09_create_event_subscription.png)

    > **Note**: Wait for Azure to finish creating the subscription before you continue with the lab. You'll receive a notification when the subscription is created.

## Task 3: Observe the subscription validation event

1. Return to the browser window displaying the **Azure Event Grid Viewer** web application.

1. Review the **Microsoft.EventGrid.SubscriptionValidationEvent** event that was created as part of the subscription creation process.

1. Select the event and review its JSON content.

1. Return to your currently open browser window with the Azure portal.

## Task 4: Record subscription credentials

1. On the Azure portal's navigation pane, select **Resource groups**.

1. On the **Resource groups** blade, select the **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** resource group that you created previously in this lab.

1. On the **PubSubEvents-<inject key="DeploymentID" enableCopy="false"/>** blade, select the **hrtopic<inject key="DeploymentID" enableCopy="false"/>** Event Grid topic that you created previously in this lab.

1. On the **Event Grid Topic** blade, record the value of the **Topic Endpoint** field. You'll use this value later in the lab.

1. In the **Settings** category, select the **Access keys** link.

1. In the **Access keys** section, record the value of the **Key 1** text box. You'll use this value later in the lab.
    
 > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:
 
 - Navigate to the Lab Validation Page, from the upper right corner in the lab guide section.
 - Hit the Validate button for the corresponding task. If you receive a success message, you can proceed to the next task. 
 - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
 - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.
 
### Review

In this exercise, you created a new subscription, validated its registration, and then recorded the credentials required to publish a new event to the topic.

# Exercise 3: Publish Event Grid events from .NET

## Task 1: Create a .NET project

1. On the **Start** screen, select the **Visual Studio Code** tile.

1. On the **File** menu, select **Open Folder**.

1. In the **File Explorer** window that opens, browse to **C:\AllFiles\AZ-204-DevelopingSolutionsforMicrosoftAzure-master\Allfiles\Labs\09\Starter\EventPublisher**, and then select **Select Folder**.

1. On the **Visual Studio Code** pop-up select **Yes, I trust the authors**.

1. In the **Visual Studio Code** window, activate the shortcut menu for the **Explorer** pane, and then select **Open in integrated Terminal**.

1. Run the following command to create a new .NET project named **EventPublisher** in the current folder:

    ```powershell
    dotnet new console --framework net6.0 --name EventPublisher --output .
    ```

    > **Note**: The **dotnet new** command will create a new **console** project in a folder with the same name as the project.

1. Run the following command to import version 4.10.0 of **Azure.Messaging.EventGrid** from NuGet:

    ```powershell
    dotnet add package Azure.Messaging.EventGrid --version 4.10.0
    ```

    > **Note**: The **dotnet add package** command will add the **Microsoft.Azure.EventGrid** package from NuGet. For more information, go to [Azure.Messaging.EventGrid](https://www.nuget.org/packages/Azure.Messaging.EventGrid/4.10.0).

1. Run the following command to build the .NET web application:

    ```powershell
    dotnet build
    ```

1. Select **Kill Terminal** or the **Recycle Bin** icon to close the currently open terminal and any associated processes.

## Task 2: Modify the Program class to connect to Event Grid

1. On the **Explorer** pane of the **Visual Studio Code** window, open the **Program.cs** file.

1. On the code editor tab for the **Program.cs** file, delete all the code in the existing file.

1. Add the following line of code to import the **Azure**, and **Azure.Messaging.EventGrid** namespaces from the **Azure.Messaging.EventGrid** package imported from NuGet:

    ```csharp
    using Azure;
    using Azure.Messaging.EventGrid;
    ```

1. Add the following lines of code to add **using** directives for the built-in namespaces that will be used in this file:

    ```csharp
    using System;
    using System.Threading.Tasks;
    ```

1. Enter the following code to create a new **Program** class:

    ```csharp
    public class Program
    {
    }
    ```

1. In the **Program** class, enter the following line of code to create a new string constant named **topicEndpoint**:

    ```csharp
    private const string topicEndpoint = "";
    ```

1. Update the **topicEndpoint** string constant by setting its value to the **Topic Endpoint** of the Event Grid topic that you recorded previously in this lab.

1. In the **Program** class, enter the following line of code to create a new string constant named **topicKey**:

    ```csharp
    private const string topicKey = "";
    ```

1. Update the **topicKey** string constant by setting its value to the **Key** of the Event Grid topic that you recorded previously in this lab.

1. In the **Program** class, enter the following code to create a new asynchronous **Main** method:

    ```csharp
    public static async Task Main(string[] args)
    {
    }
    ```

1. Observe the **Program.cs** file, which should now include the following lines of code:

    ```csharp
    using System;
    using System.Threading.Tasks;
    using Azure;
    using Azure.Messaging.EventGrid;
    
    public class Program
    {
        private const string topicEndpoint = "<topic-endpoint>";
        private const string topicKey = "<topic-key>";
        
        public static async Task Main(string[] args)
        {
        }
    }
    ```

## Task 3: Publish new events

1. In the **Main** method of Program.cs file, perform the following actions to publish a list of events to your topic endpoint:

    a. Add the following line of code to create a new variable named **endpoint** of type **Uri**, using the **topicEndpoint** string constant as a constructor parameter:

    ```csharp
    Uri endpoint = new Uri(topicEndpoint); 
    ```

    b. Add the following line of code to create a new variable named **credential** of type **[AzureKeyCredential](https://docs.microsoft.com/dotnet/api/azure.azurekeycredential)**, using the **topicKey** string constant as a constructor parameter:

    ```csharp
    AzureKeyCredential credential = new AzureKeyCredential(topicKey);
    ```

    c. Add the following line of code to create a new variable named **client** of type **[EventGridPublisherClient](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridpublisherclient)**, using the **endpoint** and **credential** variables as constructor parameters:

    ```csharp
    EventGridPublisherClient client = new EventGridPublisherClient(endpoint, credential);
    ```

    d. Add the following block of code to create a new variable named **firstEvent** of type **[EventGridEvent](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridevent)** and populate that variable with sample data:

    ```csharp
    EventGridEvent firstEvent = new EventGridEvent(
        subject: $"New Employee: Alba Sutton",
        eventType: "Employees.Registration.New",
        dataVersion: "1.0",
        data: new
        {
            FullName = "Alba Sutton",
            Address = "4567 Pine Avenue, Edison, WA 97202"
         }
     );
     ```

    e. Add the following block of code to create a new variable named **secondEvent** of type **[EventGridEvent](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridevent)** and populate that variable with sample data:

     ```csharp
        EventGridEvent secondEvent = new EventGridEvent(
            subject: $"New Employee: Alexandre Doyon",
            eventType: "Employees.Registration.New",
            dataVersion: "1.0",
            data: new
            {
                FullName = "Alexandre Doyon",
                Address = "456 College Street, Bow, WA 98107"
            }
        );
     ```

    f. Add the following line of code to asynchronously invoke the **[EventGridPublisherClient.SendEventAsync](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridpublisherclient.sendeventasync)** method using the **firstEvent** variable as a parameter:

     ```csharp
     await client.SendEventAsync(firstEvent);
     ```

    g. Add the following line of code to render the **"First event published"** message to the console:

     ```csharp
     Console.WriteLine("First event published");
     ```

    h. Add the following line of code to asynchronously invoke the **[EventGridPublisherClient.SendEventAsync](https://docs.microsoft.com/dotnet/api/azure.messaging.eventgrid.eventgridpublisherclient.sendeventasync)** method using the **secondEvent** variable as a parameter:

     ```csharp
     await client.SendEventAsync(secondEvent);
     ```

    i. Add the following line of code to render the **"Second event published"** message to the console:

     ```csharp
     Console.WriteLine("Second event published");
     ```

1. Review the **Main** method, which should now include:

    ```csharp
    public static async Task Main(string[] args)
    {
        Uri endpoint = new Uri(topicEndpoint);
        AzureKeyCredential credential = new AzureKeyCredential(topicKey);
        EventGridPublisherClient client = new EventGridPublisherClient(endpoint, credential);
        
        EventGridEvent firstEvent = new EventGridEvent(
            subject: $"New Employee: Alba Sutton",
            eventType: "Employees.Registration.New",
            dataVersion: "1.0",
            data: new
            {
                FullName = "Alba Sutton",
                Address = "4567 Pine Avenue, Edison, WA 97202"
            }
        );

        EventGridEvent secondEvent = new EventGridEvent(
            subject: $"New Employee: Alexandre Doyon",
            eventType: "Employees.Registration.New",
            dataVersion: "1.0",
            data: new
            {
                FullName = "Alexandre Doyon",
                Address = "456 College Street, Bow, WA 98107"
            }
        );

        await client.SendEventAsync(firstEvent);
        Console.WriteLine("First event published");

        await client.SendEventAsync(secondEvent);
        Console.WriteLine("Second event published");
    }
    ```

1. Save the **Program.cs** file.

1. In the **Visual Studio Code** window, activate the shortcut menu for the **Explorer** pane, and then select **Open in Integrated Terminal**.

1. Run the following command to run the .NET web application:

    ```powershell
    dotnet run
    ```

    > **Note**: If there are any build errors, review the **Program.cs** file in the **Allfiles (F):\\Allfiles\\Labs\\09\\Solution\\EventPublisher** folder.

1. Observe the success message output from the currently running console application.

1. Select **Kill Terminal** or the **Recycle Bin** icon to close the currently open terminal and any associated processes.

 > **Congratulations** on completing the task! Now, it's time to validate it. Here are the steps:

 - Navigate to the Lab Validation Page, from the upper right corner in the lab guide section.
 - Hit the Validate button for the corresponding task. If you receive a success message, you can proceed to the next task. 
 - If not, carefully read the error message and retry the step, following the instructions in the lab guide.
 - If you need any assistance, please contact us at labs-support@spektrasystems.com. We are available 24/7 to help you out.

## Task 4: Observe published events

1. Return to the browser window with the **Azure Event Grid Viewer** web application.

1. Review the **Employees.Registration.New** events that were created by your console application.

1. Select any of the events and review its JSON content.

1. Return to the Azure portal.

**You have successfully completed the lab**

### Review

In this exercise, you published new events to your Event Grid topic by using a .NET console application.

